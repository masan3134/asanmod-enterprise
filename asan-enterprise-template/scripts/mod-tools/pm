#!/bin/bash
# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
# ASANMOD v9: PM2 ALIAS WRAPPER
# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
# Usage: ./scripts/mod-tools/pm <env> <action> [service]
#
# Examples:
#   ./scripts/mod-tools/pm prod status           # All prod services status
#   ./scripts/mod-tools/pm prod restart backend  # Restart prod backend
#   ./scripts/mod-tools/pm dev logs frontend     # Show dev frontend logs
#   ./scripts/mod-tools/pm prod restart all      # Restart all prod services
#
# â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

set -e

ENV="${1:-}"
ACTION="${2:-}"
SERVICE="${3:-}"

# Color codes
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
BLUE='\033[0;34m'
NC='\033[0m' # No Color

print_usage() {
    echo ""
    echo -e "${BLUE}â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•${NC}"
    echo -e "${GREEN}ASANMOD v9: PM2 ALIAS WRAPPER${NC}"
    echo -e "${BLUE}â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•${NC}"
    echo ""
    echo "Usage: ./scripts/mod-tools/pm <env> <action> [service]"
    echo ""
    echo -e "${YELLOW}Environments:${NC}"
    echo "  dev     Development environment (ports 3000/3001)"
    echo "  prod    Production environment (ports 8204/8205)"
    echo ""
    echo -e "${YELLOW}Actions:${NC}"
    echo "  start     Start service(s)"
    echo "  stop      Stop service(s)"
    echo "  restart   Restart service(s)"
    echo "  reload    Graceful reload (prod only)"
    echo "  status    Show status"
    echo "  logs      Show logs (real-time)"
    echo "  flush     Clear logs"
    echo ""
    echo -e "${YELLOW}Services:${NC}"
    echo "  frontend  Frontend service"
    echo "  backend   Backend service"
    echo "  brain     IKAI Brain (prod only)"
    echo "  all       All services for the environment"
    echo ""
    echo -e "${YELLOW}Examples:${NC}"
    echo "  ./scripts/mod-tools/pm prod status"
    echo "  ./scripts/mod-tools/pm prod restart backend"
    echo "  ./scripts/mod-tools/pm dev logs frontend"
    echo "  ./scripts/mod-tools/pm prod restart all"
    echo ""
    exit 1
}

# Validate inputs
if [[ -z "$ENV" || -z "$ACTION" ]]; then
    print_usage
fi

if [[ "$ENV" != "dev" && "$ENV" != "prod" ]]; then
    echo -e "${RED}âŒ Invalid environment: $ENV${NC}"
    echo "   Valid options: dev, prod"
    exit 1
fi

# Map service names to PM2 process names
get_pm2_name() {
    local env=$1
    local service=$2

    case "$env-$service" in
        "dev-frontend")  echo "ikai-dev-frontend" ;;
        "dev-backend")   echo "ikai-dev-backend" ;;
        "prod-frontend") echo "ikai-prod-frontend" ;;
        "prod-backend")  echo "ikai-prod-backend" ;;
        "prod-brain")    echo "ikai-brain" ;;
        *)
            echo ""
            return 1
            ;;
    esac
}

# Get all services for an environment
get_all_services() {
    local env=$1
    if [[ "$env" == "prod" ]]; then
        echo "ikai-prod-frontend ikai-prod-backend ikai-brain"
    else
        echo "ikai-dev-frontend ikai-dev-backend"
    fi
}

# Execute PM2 command
execute_pm2() {
    local action=$1
    local target=$2

    echo -e "${BLUE}â–¶ pm2 $action $target${NC}"
    pm2 $action $target
}

# Handle actions that don't need a service
case "$ACTION" in
    "status")
        if [[ -z "$SERVICE" ]]; then
            echo -e "${GREEN}ğŸ“Š PM2 Status (All Services)${NC}"
            pm2 status
            exit 0
        fi
        ;;
    "flush")
        if [[ -z "$SERVICE" || "$SERVICE" == "all" ]]; then
            echo -e "${YELLOW}ğŸ§¹ Flushing all PM2 logs...${NC}"
            pm2 flush
            exit 0
        fi
        ;;
esac

# For other actions, service is required
if [[ -z "$SERVICE" ]]; then
    echo -e "${RED}âŒ Service not specified${NC}"
    print_usage
fi

# Handle "all" services
if [[ "$SERVICE" == "all" ]]; then
    TARGETS=$(get_all_services "$ENV")
    echo -e "${GREEN}ğŸ¯ Target: $ENV all services${NC}"
    for target in $TARGETS; do
        execute_pm2 "$ACTION" "$target"
    done
    exit 0
fi

# Get the PM2 process name
PM2_NAME=$(get_pm2_name "$ENV" "$SERVICE")

if [[ -z "$PM2_NAME" ]]; then
    echo -e "${RED}âŒ Invalid service: $SERVICE for environment: $ENV${NC}"
    echo ""
    echo "Valid services:"
    echo "  dev:  frontend, backend"
    echo "  prod: frontend, backend, brain"
    exit 1
fi

echo -e "${GREEN}ğŸ¯ Target: $PM2_NAME${NC}"

# Execute the command
case "$ACTION" in
    "start"|"stop"|"restart"|"reload"|"delete")
        execute_pm2 "$ACTION" "$PM2_NAME"
        ;;
    "logs")
        # Check if output is piped (non-interactive)
        if [ -t 1 ]; then
            # Interactive mode - show real-time logs
            echo -e "${BLUE}ğŸ“œ Showing logs for $PM2_NAME (Ctrl+C to exit)${NC}"
            pm2 logs "$PM2_NAME" --lines 50
        else
            # Non-interactive mode (piped) - show last 50 lines and exit
            pm2 logs "$PM2_NAME" --lines 50 --nostream
        fi
        ;;
    "status")
        pm2 show "$PM2_NAME"
        ;;
    *)
        echo -e "${RED}âŒ Invalid action: $ACTION${NC}"
        print_usage
        ;;
esac

echo -e "${GREEN}âœ… Done${NC}"
