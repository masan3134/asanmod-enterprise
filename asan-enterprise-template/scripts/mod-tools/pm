#!/bin/bash
# โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
# ASANMOD v1.0.0: PM2 ALIAS WRAPPER (Portable)
# โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
# Usage: ./scripts/mod-tools/pm <env> <action> [service]

set -e

ENV="${1:-}"
ACTION="${2:-}"
SERVICE="${3:-}"

# Color codes
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
BLUE='\033[0;34m'
NC='\033[0m' # No Color

print_usage() {
    echo ""
    echo -e "${BLUE}โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ${NC}"
    echo -e "${GREEN}ASANMOD v1.0.0: PM2 ALIAS WRAPPER${NC}"
    echo -e "${BLUE}โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ${NC}"
    echo ""
    echo "Usage: ./scripts/mod-tools/pm <env> <action> [service]"
    echo ""
    echo -e "${YELLOW}Environments:${NC} dev, prod"
    echo -e "${YELLOW}Actions:${NC} start, stop, restart, status, logs, flush"
    echo -e "${YELLOW}Services:${NC} frontend, backend, all"
    echo ""
    exit 1
}

# Validate inputs
if [[ -z "$ENV" || -z "$ACTION" ]]; then
    print_usage
fi

# Helper: Resolve PM2 Name via Node bridge
get_pm2_name() {
    local env=$1
    local service=$2
    node -e "const helper = require('./scripts/mod-tools/env-helper.cjs'); console.log(helper.pm2Name('$service', '$env'))" 2>/dev/null
}

# Execute PM2 command
execute_pm2() {
    local action=$1
    local target=$2

    echo -e "${BLUE}โถ pm2 $action $target${NC}"
    pm2 $action $target
}

# Handle actions that don't need a service
case "$ACTION" in
    "status")
        if [[ -z "$SERVICE" ]]; then
            echo -e "${GREEN}๐ PM2 Status (All Services)${NC}"
            pm2 status
            exit 0
        fi
        ;;
    "flush")
        echo -e "${YELLOW}๐งน Flushing all PM2 logs...${NC}"
        pm2 flush
        exit 0
        ;;
esac

# For other actions, service is required
if [[ -z "$SERVICE" ]]; then
    echo -e "${RED}โ Service not specified${NC}"
    print_usage
fi

# Handle "all" services
if [[ "$SERVICE" == "all" ]]; then
    SERVICES="frontend backend" # Assuming these are the common services across envs
    echo -e "${GREEN}๐ฏ Target: $ENV all services${NC}"
    for s in $SERVICES; do
        NAME=$(get_pm2_name "$ENV" "$s")
        if [ -n "$NAME" ]; then
            execute_pm2 "$ACTION" "$NAME"
        fi
    done
    exit 0
fi

# Get the PM2 process name
PM2_NAME=$(get_pm2_name "$ENV" "$SERVICE")

if [[ -z "$PM2_NAME" ]]; then
    echo -e "${RED}โ Could not resolve PM2 name for $SERVICE ($ENV)${NC}"
    exit 1
fi

echo -e "${GREEN}๐ฏ Target: $PM2_NAME${NC}"

# Execute the command
case "$ACTION" in
    "start"|"stop"|"restart"|"reload"|"delete")
        execute_pm2 "$ACTION" "$PM2_NAME"
        ;;
    "logs")
        # Check if output is piped (non-interactive)
        if [ -t 1 ]; then
            # Interactive mode - show real-time logs
            echo -e "${BLUE}๐ Showing logs for $PM2_NAME (Ctrl+C to exit)${NC}"
            pm2 logs "$PM2_NAME" --lines 50
        else
            # Non-interactive mode (piped) - show last 50 lines and exit
            pm2 logs "$PM2_NAME" --lines 50 --nostream
        fi
        ;;
    "status")
        pm2 show "$PM2_NAME"
        ;;
    *)
        echo -e "${RED}โ Invalid action: $ACTION${NC}"
        exit 1
        ;;
esac

echo -e "${GREEN}โ Done${NC}"
